---
title: "基于 webpack4.x 聊聊前端性能优化"
date: 2021-04-10
tags: [webpack]
categories: [📗 学习笔记]
---

本文的所有前端性能优化，都是基于webpack 的配置优化实现的。其他前端打包器配置可能有所不同，但是其中的优化方向以及优化思路都是一致的，值得学习了解一二。

本文主要从开发环境和生产环境两个方面去优化webpack配置文件，毕竟这两个环境优化的目的有所不同，开发环境优化的目的是尽可能提升编程时的体验，帮助我们尽快定位BUG等等，而生产环境却更在意的是提升生产代码的性能，加快代码编译速度等等。

## 开发环境优化

### 热模块替换（Hot module replacement）

开发过程中，当一个模块代码发生变化，只会重新打包构建这一个模块，而不是全部重新打包所有模块，以此提升开发时的构建速度，做到代码修改后，预览界面及时响应。幸运的是webpack已经实现了它，只需要在devServer中设置hot为true，就会自动开启HMR功能，但是HMR只能在开发模式下使用。

```javascript
devServer: {
  contentBase: resolve(__dirname, 'build'),
  compress: true,
  port: 3000,
  open: true,
  // 开启HMR功能
  // 当修改了webpack配置，新配置要想生效，必须重启webpack服务
  hot: true
}
```

但是在webpack中，不是所有的资源文件都能支持HMR，具体情况如下：

+ CSS、SASS 等样式文件，可以使用HMR功能，因为开发环境下使用的style-loader内部默认实现了热模块替换功能。

+ JS 文件：默认不能使用HMR功能，修改一个js模块，所有js模块都会刷新。
  想要让js文件支持HMR，需要添加支持HMR功能的代码：

  ```javascript
  // 绑定
  if (module.hot) {
    // 一旦 module.hot 为true，说明开启了HMR功能。 --> 让HMR功能代码生效
    module.hot.accept('./print.js', function() {
      // 方法会监听 print.js 文件的变化，一旦发生变化，只有这个模块会重新打包构建，其他模块不会。
      // 会执行后面的回调函数
      print();
    });
  }
  ```

+ HTML 文件：默认不能使用 HMR 功能，但也不必使用，因为只有一个入口文件 index.html ，不需要再单独优化。
  倘若强行使用HMR会导致html文件不能自动打包构建了。解决办法就是修改entry入口，将html文件引入，这样可以整体修改刷新：

  ```javascript
  entry:['./src/js/index.js', './src/index.html']
  ```

  ### source-map

  这是一种提供修改源代码到构建后代码的映射技术，在构建后代码出错的情况下，可以通过此技术快速追踪到源代码错误。

  **格式**：`devtool: '[inline-|hidden-|eval-][nosources-][cheap-[module-]]source-map'`

  **含义**：[生成source-map的位置|给出的错误代码信息的详细程度] 所有前缀都可以自由组合

  - source-map：外部，错误代码准确信息 和 源代码的错误位置
  - inline-source-map：内联，只生成一个内联 source-map，错误代码准确信息 和 源代码的错误位置
  - hidden-source-map：外部，错误代码错误原因，但是没有错误位置（为了隐藏源代码），不能追踪源代码错误，只能提示到构建后代码的错误位置
  - eval-source-map：内联，每一个文件都生成对应的 source-map，都在 eval 中，错误代码准确信息 和 源代码的错误位置
  - nosources-source-map：外部，错误代码准确信息，但是没有任何源代码信息（为了隐藏源代码）
  - cheap-source-map：外部，错误代码准确信息 和 源代码的错误位置，只能把错误精确到整行，忽略列
  - cheap-module-source-map：外部，错误代码准确信息 和 源代码的错误位置，module 会加入 loader 的 source-map

  **内联和外部的区别**：

  1. 外部生成了文件，内联没有 2. 内联构建速度更快

  #### 开发/生产环境的选择建议：

  **开发环境**：需要考虑速度快，调试更友好

  - 速度快( eval > inline > cheap >... )
    1. eval-cheap-souce-map
    2. eval-source-map（完整度高，内联速度快）
  - 调试更友好
    1. souce-map
    2. cheap-module-souce-map（错误提示忽略列但是包含其他信息，内联速度快
    3. cheap-souce-map

  **生产环境**：需要考虑源代码是否隐藏，是否需要调试

  - 内联会让代码体积变大，所以在生产环境不用内联
  - 隐藏源代码
    1. nosources-source-map 全部隐藏
    2. hidden-source-map 只隐藏源代码，会提示构建后代码错误信息

## 生产环境优化

生产环境的优化主要从打包构建速度以及代码运行的性能两个方面去考虑：

未完待续。。。。。